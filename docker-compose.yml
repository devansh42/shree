version: "3.0"

services: 
    backend:
        image: devansh42/shree-backend:latest
        expose: 
            - 4200
        hostname: backend
        ports: 
            - "4200:4200" 
        depends_on: 
            - redis
            - ca    
        networks: 
            - ca
            - backend   
        volumes: 
            - "/dvol/shree/backend:/root"    
        command: "./back -baddr :4200 -caddr ca:5200 -raddr redis:6379"    
  
  
  
    redis:
        image: redis:alpine
        hostname: redis
        expose: 
            - 6379
        networks: 
            - ca
        volumes: 
            - "/dvol/shree/redis:/data"    
            
    ca:
        hostname: ca
        image:  devansh42/shree-ca:latest
        networks: 
            - ca
        expose:
            - 5200    
        volumes: 
            - "/dvols/shree/ca:/root"
            - "/dvols/shree/keys/ca:/ca/keys"    
        command: "./ca -addr :5200 -hprv /ca/keys/ca_host_key -hpub /ca/keys/ca_host_key.pub -uprv /ca/keys/ca_user_key -upub /ca/keys/ca_user_key.pub"   
        
        

    serv:
        image: devansh42/shree-serv:latest                
        networks: 
            - backend
        depends_on: 
            - backend
        hostname: serv
        expose:
            - 6200
        volumes: 
            - "/dvols/shree/serv:/root"
            - "/dvols/shree/keys/serv:/serv/keys"    
        command: "./serv -addr :6200 -baddr backend:4200 -host localhost:6200 -prv /serv/keys/id_host -pub /serv/keys/id_host.pub"        


networks: 
    ca:
        driver: bridge
     
    backend:
        driver: bridge
     
